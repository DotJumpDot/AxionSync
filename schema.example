# AxionSync Database Schema Documentation

## Overview
AxionSync uses PostgreSQL as its relational database. The application manages users and their memos with full CRUD operations.

---

## Entity Models

### 1. User Entity
**File:** `src/models/entity/en_user.py`

| Field | Type | Nullable | Description |
|-------|------|----------|-------------|
| id | int | No | Primary key, auto-incremented user ID |
| username | str | No | Unique username for login |
| firstname | str | Yes | User's first name |
| lastname | str | Yes | User's last name |
| nickname | str | Yes | User's nickname/display name |
| role | str | No | User role (default: "user") |
| tel | str | Yes | Telephone number |
| created_at | datetime | No | Record creation timestamp (UTC) |
| updated_at | datetime | Yes | Record last update timestamp (UTC) |

**Notes:**
- `username` should be UNIQUE for authentication
- `role` is used for authorization (e.g., "user", "admin")
- Timestamps are stored in UTC

---

### 2. Memo Entity
**File:** `src/models/entity/en_memo.py`

| Field | Type | Nullable | Description |
|-------|------|----------|-------------|
| id | int | No | Primary key, auto-incremented memo ID |
| title | str | No | Memo title |
| content | str | No | Memo content/body text |
| user_id | int | No | Foreign key referencing User.id |
| deleted_status | bool | No | Soft delete flag (default: False) |
| created_at | datetime | No | Record creation timestamp (UTC) |
| updated_at | datetime | Yes | Record last update timestamp (UTC) |

**Relationships:**
- Many-to-One: Multiple memos can belong to one user
- Foreign Key: `user_id` → `users.id`

**Notes:**
- Uses soft delete pattern (deleted_status = true instead of removing rows)
- Each memo must be associated with a user
- Timestamps are stored in UTC

---

## API Request/Response Models

### LoginRequest
```
username: str (required)
password: str (required)
```

### CreateMemoRequest
```
title: str (required)
content: str (required)
```

### UpdateMemoRequest
```
title: str (required)
content: str (required)
```

---

## SQL Schema Creation Scripts

### Prerequisites
```sql
-- Connect to your PostgreSQL database
CREATE DATABASE axionsync;
\c axionsync
```

### 1. Create Users Table
```sql
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    firstname VARCHAR(255),
    lastname VARCHAR(255),
    nickname VARCHAR(255),
    role VARCHAR(50) NOT NULL DEFAULT 'user',
    tel VARCHAR(20),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE
);

-- Create index on username for faster login queries
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_created_at ON users(created_at);
```

### 2. Create Memos Table
```sql
CREATE TABLE IF NOT EXISTS memos (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    user_id INTEGER NOT NULL,
    deleted_status BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE,
    CONSTRAINT fk_memos_user_id FOREIGN KEY (user_id) 
        REFERENCES users(id) ON DELETE CASCADE
);

-- Create indexes for common queries
CREATE INDEX idx_memos_user_id ON memos(user_id);
CREATE INDEX idx_memos_created_at ON memos(created_at DESC);
CREATE INDEX idx_memos_deleted_status ON memos(deleted_status);
CREATE INDEX idx_memos_user_deleted ON memos(user_id, deleted_status);
```

### 3. Complete SQL Script (Run All at Once)
```sql
-- Drop existing tables (optional - use for development/testing only)
-- DROP TABLE IF EXISTS memos CASCADE;
-- DROP TABLE IF EXISTS users CASCADE;

-- Create users table
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    firstname VARCHAR(255),
    lastname VARCHAR(255),
    nickname VARCHAR(255),
    role VARCHAR(50) NOT NULL DEFAULT 'user',
    tel VARCHAR(20),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE
);

-- Create indexes for users table
CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
CREATE INDEX IF NOT EXISTS idx_users_created_at ON users(created_at);

-- Create memos table
CREATE TABLE IF NOT EXISTS memos (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    user_id INTEGER NOT NULL,
    deleted_status BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE,
    CONSTRAINT fk_memos_user_id FOREIGN KEY (user_id) 
        REFERENCES users(id) ON DELETE CASCADE
);

-- Create indexes for memos table
CREATE INDEX IF NOT EXISTS idx_memos_user_id ON memos(user_id);
CREATE INDEX IF NOT EXISTS idx_memos_created_at ON memos(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_memos_deleted_status ON memos(deleted_status);
CREATE INDEX IF NOT EXISTS idx_memos_user_deleted ON memos(user_id, deleted_status);
```

---

## Common Queries

### Get all non-deleted memos for a user (ordered by creation date)
```sql
SELECT m.* FROM memos m
WHERE m.user_id = $1 AND m.deleted_status = FALSE
ORDER BY m.created_at DESC;
```

### Get user with password hash (for authentication)
```sql
SELECT * FROM users WHERE username = $1;
```

### Get a single memo with user details
```sql
SELECT m.*, u.* FROM memos m
JOIN users u ON m.user_id = u.id
WHERE m.id = $1 AND m.deleted_status = FALSE;
```

### Soft delete a memo
```sql
UPDATE memos SET deleted_status = TRUE, updated_at = CURRENT_TIMESTAMP
WHERE id = $1;
```

### Create a new user
```sql
INSERT INTO users (username, password_hash, firstname, lastname, nickname, role, tel)
VALUES ($1, $2, $3, $4, $5, $6, $7)
RETURNING *;
```

### Create a new memo
```sql
INSERT INTO memos (title, content, user_id)
VALUES ($1, $2, $3)
RETURNING *;
```

---

## Database Constraints & Relationships

### Data Integrity
- **User PK**: `id` - ensures each user has a unique identifier
- **Memo FK**: `user_id` → `users.id` - enforces referential integrity
- **Cascade Delete**: Deleting a user automatically removes their memos
- **Unique Username**: Prevents duplicate user registrations

### Indexing Strategy
- `users.username`: Fast authentication lookups
- `users.created_at`: Sorting/filtering users by registration date
- `memos.user_id`: Quick retrieval of user's memos
- `memos.created_at DESC`: Efficient recent memo fetching
- `memos.deleted_status`: Fast filtering of non-deleted memos
- `memos(user_id, deleted_status)`: Composite index for common query pattern

---

## Environment Configuration
Ensure your `.env` file contains:
```
DATABASE_URL=postgresql://user:password@localhost:5433/axionsync
JWT_EXPIRE_MINUTES=60
X_API_KEY=['1234']
```

---

## Migration Notes
- All timestamps use `TIMESTAMP WITH TIME ZONE` for consistency across timezones
- Soft delete pattern used for memos (never physically deleted)
- Passwords stored as hashed values using bcrypt
- User roles support future authorization features
